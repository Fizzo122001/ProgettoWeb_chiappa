<!DOCTYPE html>
<html lang="it">

<head>
    <%- include('head') %>
    <title>
        <%= title %>
    </title>
    <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/4.5.2/css/bootstrap.min.css">
    <link rel="stylesheet" href="css/style.css">
    <style>
        .product {
            margin-bottom: 2rem;
        }
    </style>
</head>

<body class="gradient-custom">
    <%- include("header.ejs", { authenticated, title, prodotti, coach: 0 }) %>
    <main>
        <div class="text-center mt-4 mb-4">
            <h4>Esplora le nostre attrezzature fitness</h4>
        </div>
        <div class="container">
            <div class="row">
                <% prodotti.forEach(function(product) { %>
                <div class="col-md-3">
                    <div class="product card">
                        <img class="card-img-top" src="/image/<%= product.immagine %>" alt="<%= product.nome %>">
                        <div class="card-body">
                            <h4 class="card-title">
                                <%= product.nome %>
                            </h4>
                            <p class="card-text">Prezzo: €<%= product.prezzo.toFixed(2) %>
                            </p>
                            <form class="form-prodotto" data-nome="<%= product.nome %>" data-prezzo="<%= product.prezzo %>">
                                <button type="submit" class="btn btn-warning">Aggiungi al carrello</button>
                            </form>

                        </div>
                    </div>
                </div>
                <% }); %>
            </div>
        </div>
    </main>
    <footer>
        <%- include('footer') %>
    </footer>
    <script>
        document.querySelectorAll('.form-prodotto').forEach(function(form) {
            form.addEventListener('submit', function(event) {
                event.preventDefault(); // Impedisce il comportamento predefinito del form
                var nome = this.dataset.nome;
                var prezzo = parseFloat(this.dataset.prezzo);
                aggiungiAlCarrello(nome, prezzo);
                return false; // Restituiamo false per evitare il comportamento predefinito del form
            });
        });

        var carrello = [];

        function inizializza() {
            if (localStorage.carrello) {
                carrello = JSON.parse(localStorage.carrello);
                console.log('Carrello caricato da LocalStorage:', carrello);
                tabella();
            }
        }

        function serializza() {
            localStorage.carrello = JSON.stringify(carrello);
            console.log('Carrello salvato in LocalStorage:', carrello);
        }

        function aggiungiAlCarrello(nome, prezzo) {
            var prodotto = carrello.find(item => item.nome === nome);

            if (prodotto) {
                prodotto.qnt++;
            } else {
                var nuovoProdotto = {
                    codice: carrello.length, // Usare l'indice dell'array come codice
                    nome: nome,
                    prezzo: prezzo, 
                    qnt: 1
                };
                carrello.push(nuovoProdotto);
            }

            serializza();
            alert(nome + " aggiunto al carrello");
            tabella(); // Aggiorna la tabella ogni volta che si aggiunge un prodotto
        }

        function totali() {
            var totale = 0;

            for (var i = 0; i < carrello.length; i++) {
                var id = "t" + i;
                var prodotto = carrello[i];
                var totaleProdotto = prodotto.prezzo * prodotto.qnt;
                document.getElementById(id).textContent = totaleProdotto.toFixed(2);
                totale += totaleProdotto;
            }

            document.getElementById('totale').textContent = totale.toFixed(2);
            return totale;
        }

        function cambia(cella) {
            var label = "q" + cella;
            var v = document.getElementById(label).value;
            carrello[cella].qnt = parseInt(v);
            serializza();
            totali();
        }

        function tabella() {
            var tableHTML = "<table class='table carrello-tabella' border='1'><thead><tr><th>Codice</th><th>Nome</th><th>Prezzo</th><th>Quantità/Ore</th><th>Totale</th></tr></thead><tbody>";
            for (var i = 0; i < carrello.length; i++) {
                var prodotto = carrello[i];
                tableHTML += "<tr><td class='center'>" + prodotto.codice;
                tableHTML += "<td>" + prodotto.nome;
                tableHTML += "<td class='right'>" + prodotto.prezzo.toFixed(2);
                tableHTML += "<td><input onChange='cambia(" + i + ")' class='center' id='q" + i + "' type='text' size='4' value='" + prodotto.qnt + "'>";
                tableHTML += "<td class='right' id='t" + i + "'>&nbsp;</td></tr>";
            }
            tableHTML += "<tr><td colspan='4' class='right' align='right'>Importo Ordine</td><td class='right' id='totale'>&nbsp;</td></tr></tbody></table>";

            document.getElementById('elenco').innerHTML = tableHTML;
            totali();
        }

        function svuota() {
            localStorage.removeItem('carrello');
            carrello = [];
            tabella();
        }

        function paga() {
            if (localStorage.carrello) {
                var totale = totali();
                inviaOrdine(totale);
            } else {
                alert("Il carrello è vuoto, aggiungi almeno un prodotto per ordinare.");
            }
        }

        document.addEventListener('DOMContentLoaded', inizializza);
    </script>
</body>

</html>
